---
title: den.ctx Reference
description: Context type definitions and their built-in implementations.
---

import { Aside } from '@astrojs/starlight/components';

<Aside title="Use the Source, Luke" icon="github">[`modules/context/types.nix`](https://github.com/vic/den/blob/main/modules/context/types.nix) · [`modules/context/os.nix`](https://github.com/vic/den/blob/main/modules/context/os.nix) · [`modules/aspects/defaults.nix`](https://github.com/vic/den/blob/main/modules/aspects/defaults.nix) · Tests: [`context/`](https://github.com/vic/den/tree/main/templates/ci/modules/features/context) · [`host-propagation.nix`](https://github.com/vic/den/blob/main/templates/ci/modules/features/context/host-propagation.nix)</Aside>

## Context Type Schema

Each `den.ctx.<name>` is an [aspect submodule](/explanation/aspects/) extended
with context transformations. It inherits all options from `flake-aspects`'s
`aspect`-type and adds `into`, and a couple of conventions:

| Option | Type | Description |
|--------|------|-------------|
| `description` | `str` | Human-readable description |
| `provides.${name}` | `ctx → aspect` | Self-named provider: locates the aspect for this context |
| `provides.${target}` | `ctx → aspect` | Cross-provider: source's contribution to target contexts |
| `into` | `attrset of (ctx → list)` | Transformations to other contexts |
| `includes` | `list of aspect` | Parametric aspects activated for this context |

Context types are also functors — callable as functions:

```nix
aspect = den.ctx.host { host = den.hosts.x86_64-linux.igloo; };
```

## ctxApply (internal)

When a context type is applied, `ctxApply` walks the full `into` graph
and deduplicates includes using a seen-set:

```nix
ctxApply = ctxName: _self: ctx:
  let
    pairs = collectPairs null den.ctx.${ctxName} ctx;
  in
  { includes = dedupIncludes pairs; };
```

**collectPairs** recursively walks `into` transformations, producing
`(source, ctxDef, ctx)` triples for every reachable context type.
The `source` tracks which context type produced the transformation.

**dedupIncludes** processes triples with a seen-set keyed by context name:

- **First visit**: `fixedTo ctx (cleanCtx ctxDef)` — dispatches owned, static, and parametric includes — plus self-provider and cross-provider
- **Subsequent visits**: `atLeast (cleanCtx ctxDef) ctx` — dispatches only parametric includes — plus self-provider and cross-provider

For each triple, three providers are called:
1. **Self-provider** `ctxDef.provides.${ctxDef.name}` — the target's own aspect lookup
2. **Cross-provider** `source.provides.${ctxDef.name}` — the source's contribution to this target (if defined)

## Transformation Types

All `into` transformations have the type `source → [ target ]`:

- **Fan-out**: `{ host }: map (u: { inherit host user; }) users` — one host produces N contexts
- **Conditional**: `{ host }: lib.optional (test host) { inherit host; }` — zero or one
- **Pass-through**: `lib.singleton` — forward the same data as-is

An empty list means the target context is not created. This enables
conditional activation like HM detection without any explicit `if` logic
in the pipeline.

## Contexts as Cutting-Points

Context types have their own owned configs and `includes`, making them
aspect-like cutting-points in the pipeline:

```nix
den.ctx.hm-host.nixos.home-manager.useGlobalPkgs = true;
den.ctx.hm-host.includes = [
  ({ host, ... }: { nixos.home-manager.backupFileExtension = "bak"; })
];
```


## Extending Context Flow

Add transformations to existing context types from any module:

```nix
den.ctx.hm-host.into.foo = { host }: [ { foo = host.name; } ];
den.ctx.foo._.foo = { foo }: { funny.names = [ foo ]; };
```

The module system merges these definitions. You can also override a
host's `mainModule` to use a completely custom context flow.

## Built-in Context Types

### den.ctx.host

| Field | Value |
|-------|-------|
| `description` | OS |
| `provides.host` | `{ host }:` fixedTo host aspect |
| `provides.user` | `{ host, user }:` host's contribution to user contexts (cross-provider) |
| `into.default` | `lib.singleton` (pass-through) |
| `into.user` | Enumerate `host.users` |
| `into.hm-host` | Detect HM support (from `hm-detect.nix`) |

### den.ctx.user

| Field | Value |
|-------|-------|
| `description` | OS user |
| `provides.user` | `{ host, user }:` fixedTo user aspect |
| `into.default` | `lib.singleton` (pass-through) |

### den.ctx.default

| Field | Value |
|-------|-------|
| `provides.default` | `_: { }` (empty — just a dispatcher) |

Aliased as `den.default` via `lib.mkAliasOptionModule`.
Writing `den.default.foo` is identical to `den.ctx.default.foo`.

Host/user/home context types transforms into `default`, so `den.default.includes`
functions run at each of their pipeline stages. However, owned and static configs
are **automatically deduplicated** — only the first visit gets them.
Parametric functions still run at every stage; use `take.exactly` to
restrict matching if needed.

### den.ctx.home

| Field | Value |
|-------|-------|
| `description` | Standalone Home-Manager config |
| `provides.home` | `{ home }:` fixedTo home aspect |
| `into.default` | `lib.singleton` |

### den.ctx.hm-host

| Field | Value |
|-------|-------|
| `description` | Host with HM-supported OS and HM users |
| `provides.hm-host` | `{ host }:` imports HM NixOS/Darwin module |
| `into.hm-user` | Enumerate HM-class users |

**Detection criteria** (all must be true):
1. Host class is `nixos` or `darwin`
2. At least one user has `class = "homeManager"`
3. `inputs.home-manager` exists, or host has a custom `hm-module` attribute

If detection fails, the HM pipeline is skipped entirely.

### den.ctx.hm-user

| Field | Value |
|-------|-------|
| `description` | Internal — forwards HM class to host |
| `provides.hm-user` | `{ host, user }:` forward homeManager into host |

### den.ctx.hm-internal-user (internal)

An internal context type used by `hm-user`. It combines:
- The user context (`den.ctx.user { host, user }`)
- Owned configs from the host aspect
- Static includes from the host aspect
- Parametric includes from the host aspect matching `{ host, user }`

This ensures that when the `homeManager` class is forwarded into
`home-manager.users.<name>`, it receives contributions from both
the user's aspect and the host's aspect.
