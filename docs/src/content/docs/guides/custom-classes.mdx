---
title: Custom Nix Classes
description: Create new Nix configuration classes with den._.forward.
---

import { Aside } from '@astrojs/starlight/components';

<Aside title="Use the Source, Luke" icon="github">[`modules/aspects/provides/forward.nix`](https://github.com/vic/den/blob/main/modules/aspects/provides/forward.nix) · [CI tests](https://github.com/vic/den/blob/main/templates/ci/modules/forward.nix)</Aside>

## What Are Custom Classes?

Den natively supports `nixos`, `darwin`, and `homeManager` classes. But you
can create your own classes that forward their settings into any target
submodule. This is exactly how Home-Manager integration works internally.

## The forward Battery

`den._.forward` creates an aspect that takes configs from a source class
and inserts them into a target class at a specified path.

## Example: How Den forwards `hjem` user class to NixOS

Den already integrates nix-maid and hjem just like home-manager.

Forward a new `hjem` class into NixOS top-level:

```nix
{ den, lib, ... }:
let
  hjem = { host }: { class, aspect-chain }:
    den._.forward {
      each = host.users;
      fromClass = user: "hjem";
      intoClass = user: class;
      intoPath = user: [ "hjem" "users" user.userName ]
      fromAspect = user: den.aspects.${user.aspect};
    };
in {
  # host forwards user hjem modules into nixos level.
  den.aspects.igloo = { includes = [ hjem ]; };

  # user aspect has hjem class
  # settings at host become nixos.hjem.users.<userName> = ...;
  den.aspects.tux.hjem  = { ... };
}
```


## Use Cases

- **User environments**: Forward a `user` class into `users.users.<name>`
- **nix-maid / hjem**: Built-in integrations, see [batteries](/guides/batteries/)
- **Containerization**: Forward a `container` class into systemd-nspawn configs
- **VM configs**: Forward a `vm` class into microvm or QEMU settings
- **Guarded classes**: Forward only when target options exist (eg, Impermanence)
- **Custom tools**: Forward into any Nix-configurable system (NixVim, etc.)

## Guarded Forward

Use `guard` to conditionally forward only when target options exist:

```nix
# Custom `persys` forwards config into nixos.environment.persistance."/nix/persist/system"
# only if environment.persistance option is present.
persys = { class, aspect-chain }: den._.forward {
  each = lib.singleton true;
  fromClass = _: "persys";
  intoClass = _: class;
  intoPath = _: [ "environment" "persistance" "/nix/persist/system" ];
  fromAspect = _: lib.head aspect-chain;
  guard = { options, ... }: options ? environment.persistance;
};

den.hosts.my-laptop.includes = [ persys ];

# becomes nixos.environment.persistance."/nix/persist/system".hideMounts = true;
den.hosts.my-laptop.persys.hideMounts = true;
```

When the guard returns `false`, forwarded settings are silently ignored.

## Creating Your Own

The `forward` function parameters:

| Parameter | Description |
|-----------|-------------|
| `each` | List of items to iterate over |
| `fromClass` | Source class name (string) |
| `intoClass` | Target class name (string) |
| `intoPath` | Attribute path in target (list of strings) |
| `fromAspect` | Source aspect to read from |
| `guard` | Optional: `{ options, ... }@args -> bool` — forward only when true |
| `adaptArgs` | Optional: args->specialArgs for the intermediate submodule |
